<meta charset="utf-8">

<script>

const listedPeople = [
  {
    "email": "Brian email",
    "id": 938705020378835700,
    "name": "Brian",
  },
  {
    "email": "Dana email",
    "id": 679486706697450400,
    "name": "Dana",
  },
  {
    "email": "Em email",
    "id": 223820751693978620,
    "name": "Em",
  },
  {
    "email": "Jack email",
    "id": 83417727648052880,
    "name": "Jack",
  },
  {
    "email": "Michael email",
    "id": 652899634236487300,
    "name": "Michael",
  },
  {
    "email": "Lauren email",
    "id": 900741110005811700,
    "name": "Lauren",
  },
];

console.log('listedPeople:', listedPeople);

const listedInclusions = [
  {
    "from": 938705020378835700,
    "id": 56278601168576744,
    "to": 652899634236487300,
  },
];

console.log('listedInclusions:', listedInclusions);

const listedExclusions = [
  {
    "from": 938705020378835700,
    "id": 158414670150343700,
    "to": 679486706697450400,
  },
  {
    "from": 679486706697450400,
    "id": 160007785937532830,
    "to": 938705020378835700,
  },
  {
    "from": 223820751693978620,
    "id": 158482040150343700,
    "to": 83417727648052880,
  },
  {
    "from": 83417727648052880,
    "id": 160007785193832830,
    "to": 223820751693978620,
  },
];

console.log('listedExclusions:', listedExclusions);

function randomize(arrayIn) {
    let arrayOut = [];
    for(let i in arrayIn) {
        let randomIndex = Math.floor(Math.random() * arrayIn.length);
        while(arrayOut.includes(arrayIn[randomIndex])) {
            randomIndex = Math.floor(Math.random() * arrayIn.length);
        }
        arrayOut[i] = arrayIn[randomIndex];
    }
    return arrayOut;
}

function randomizePeople(listedPeople) {
    var randomizedListedPeople = randomize(listedPeople);
    randomizedListedPeople = randomize(randomizedListedPeople);
    randomizedListedPeople = randomize(randomizedListedPeople);
    randomizedListedPeople = randomize(randomizedListedPeople);

    return randomizedListedPeople;
};

function get_vectors(randomizedListedPeople, listedInclusions, listedExclusions) {

  console.log('------------------');
  console.log('------------------');
  console.log('------------------');
  console.log('<Start function>');
  console.log('------------------');
  console.log('------------------');
  console.log('------------------');

  let vectors = {};

  console.log('Initial vectors (empty):', vectors);

  for (listedInclusion of listedInclusions) {

    console.log('<Start inclusions for loop>');

    console.log('listedInclusion:', listedInclusion);

    vectors[listedInclusion['from']] = listedInclusion['to'];
  }

  console.log('>Inclusions assigned to vectors')

  console.log('vectors:', vectors);

  let excluded = false;
  let matched = false;
  let iterations = 0;
  let person2;
  let n = 0;

  for (let [i, person1] of Object.entries(randomizedListedPeople)) {

    console.log('------------------');
    console.log('------------------');
    console.log('<Start for loop>');
    console.log('------------------');
    console.log('------------------');

    console.log('Person to get assignment:', i, person1);

    matched = false;
    iterations = 0;

    if (!(person1['id'] in vectors)) {

      console.log('>Person is not already in vectors, so assigment can proceed');

      if (i == (randomizedListedPeople.length - 1)) {
        n = 0;

        console.log('>Person is last in list so next person to try to assign to is actually the first person in the list');
        console.log('n: ', n);

      } else {
        n = parseInt(i) + 1;

        console.log('>Person is not the last in list, so next person is just the next index');
        console.log('n: ', n);

      }

      while (!(matched)) {

        console.log('------------------');
        console.log('<Start while loop>')
        console.log('------------------');

        console.log('>Not matched yet, so while loop proceeds')

        if (iterations < (randomizedListedPeople.length * 2)) {

          console.log('iterations:', iterations);
          console.log('>iterations still below 2 times list length (haven\'t run through twice yet), so while loop keeps going');

          excluded = false;
          person2 = randomizedListedPeople[n];

          console.log('Person being tested for assignment:', person2);

          if (person2 == person1) {

            console.log('Person 2 is same as person 1. Go to next person 2.')

            if (n >= (randomizedListedPeople.length - 1)) {
              n = 0;
            } else {
              n++;
            }
            iterations++;

            console.log('n: ', n);

          } else if (person2['id'] in Object.values(vectors)) {

            console.log('Person 2 is already assigned to someone else. Move on to next person 2.');

            if (n >= (randomizedListedPeople.length - 1)) {
              n = 0;
            } else {
              n++;
            }
            iterations++;

            console.log('n: ', n);

          } else {

            for (listedExclusion of listedExclusions) {

              console.log('<Start for loop (run through exclusions)>')

              if (listedExclusion['from'] == person1['id'] && listedExclusion['to'] == person2['id']) {

                console.log('Exclusion from', listedExclusion['from'], 'is person 1 and exclusion to', listedExclusion['to'], 'is person 2. This exclusion applies. Assignment can\'t proceed. Break out of the for loop.');

                excluded = true;
                break;
              } else {

                console.log('This exclusion (', listedExclusion['from'], 'can\'t give to', listedExclusion['to'], ') doesn\'t apply. Keep going through rest of exclusions.');

              }
            }

            if (excluded) {

              console.log('Since exclusion was found, person 2 can\'t be assigned to person 1, so try the next person 2');

              if (n >= (randomizedListedPeople.length - 1)) {
                n = 0;
              } else {
                n++;
              }
              iterations++;

              console.log('n: ', n);

            } else {

              console.log('Success: person 1', person1['id'], 'can give to person 2', person2['id']);

              vectors[person1['id']] = person2['id'];
              matched = true;

            }
          }
        } else {

          console.log('No assignment found for this person 1. Start over: re-randomize and call this assignment function all over again.');

          return {0: 0};

        }
      }
    } else {
      console.log('>Person is already in vectors, so assigment does not proceed');
    }
    console.log(vectors);
  }

  return vectors;

}


var vectors = {0: 0};

console.log(vectors[0] === 0);

var randomizedListedPeople = {};

let maxIterations = 3;
let iterations = 0;

while (vectors[0] === 0 && iterations <= maxIterations) {
  iterations++;
  randomizedListedPeople = randomizePeople(listedPeople);
  console.log(randomizedListedPeople);
  vectors = get_vectors(randomizedListedPeople, listedInclusions, listedExclusions);
  console.log(vectors);
}

console.log(vectors);

</script>
